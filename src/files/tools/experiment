#!/usr/bin/python3
# -*- coding: UTF-8 -*-
from pbox import *
from tinyscript import *


_NAME = config.get('experiment')

__script__      = "Experiment management tool"
__version__     = "1.1.3"
__doc__         = """
This tool aims to manage an experiment (a structure that can hold custom YAML configurations, datasets and models).
"""
__description__ = "Manipulate experiments (dedicated workspaces for datasets, models and custom configs)"
__examples__ = [[
    "close",
    "commit",
    "compress",
    "edit",
    "edit features",
    "list",
    "show",
], [
    "compress my-experiment",
    "list",
    "open my-experiment",
    "purge test-*",
]][_NAME == ""]


if __name__ == '__main__':
    sparsers = parser.add_subparsers(dest="command", metavar="CMD", title="positional argument",
                                     help="command to be executed")
    if _NAME is None:
        add_argument(sparsers.add_parser("compress", help="convert the datasets of an experiment to fileless datasets"),
                     "xpname")
        sparsers.add_parser("list", help="list the existing experiments")
        add_argument(sparsers.add_parser("open", help="create a new or open an existing experiment"), "xpname",
                     force=True)
        add_argument(sparsers.add_parser("purge", help="purge an experiment"), "xpname",
                     note="use 'all' to purge every dataset or the wildcard '*' to select a part of them")
    else:
        sparsers.add_parser("close", help="close the current experiment")
        commit = sparsers.add_parser("commit", help="commit the last OS command to the resource file (commands.rc)")
        commit.add_argument("-f", "--force", action="store_true", help="commit without confirmation")
        commit.add_argument("-q", "--quiet", dest="silent", action="store_true",
                              help="do not show warning if nothing to commit")
        sparsers.add_parser("compress", help="convert the datasets to fileless datasets")
        sparsers.add_parser("edit", help="edit the README file or a YAML configuration file") \
                .add_argument("config", nargs="?", default="README", metavar="NAME",
                              help="edit the target experiment's README(.md), commands(.rc) or YAML configuration file")
        sparsers.add_parser("import", help="import a YAML configuration file from anywhere") \
                .add_argument("config", type=yaml_file, metavar="YAML",
                              help="import the target YAML configuration file(s) within the experiment")
        sparsers.add_parser("list", help="list the existing experiments")
        sparsers.add_parser("play", help="play the given scenario and update commands.rc") \
                .add_argument("scenario", type=scenario_identifier, help="scenario to be played")
        sparsers.add_parser("replay", help="replay commands from experiment's commands.rc")
        sparsers.add_parser("show", help="get an overview of the experiment")
    initialize(noargs_action="usage")
    configure_logging(args.verbose)
    # prepare parsed arguments
    name = getattr(args, "name", _NAME)
    # now execute
    if args.command == "purge":
        Experiment.purge(name)
    elif args.command == "list":
        Experiment.list()
    elif name == "all":
        logger.warning("Experiment cannot be named 'all' (reserved word)")
    elif args.command == "import":  # rationale: cannot name a method 'import' (Python-reserved word)
        Experiment(name)._import(**vars(args))
    elif args.command == "edit":
        Experiment(name).edit(config=args.config, force=True)
    else:
        getattr(Experiment(name), args.command)(**vars(args))

