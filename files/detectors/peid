#!/usr/bin/python3
# -*- coding: UTF-8 -*-
from pboxtools import *


DB = "/opt/detectors/userdb.txt"


def execute(name, **kwargs):
    with open(kwargs['db'], encoding="latin-1") as f:
        sigs = peutils.SignatureDatabase(data=f.read())
    return "\n".join(sigs.match(pefile.PE(kwargs['path']), ep_only=True) or []), None


def parse(output):
    for s in output.splitlines():
        try:
            p = re.match(r"^\[(?:.*?)((?:[A-Z$][A-Za-z0-9]{2,}(?:\d+)?(?:'s)?(?:\s+)?)+)", s).group(1).strip()
            return re.sub(r"[\s-]+", "_", sub(r"['/]", "", p.replace("'s", "")), p).lower()
        except AttributeError:
            pass


if __name__ == "__main__":
    run("PEiD", exec_func=execute, parse_func=parse, exe_type="pe", exe_help="path to the PE file",
        parser_args=[(2, ("-d", "--db"), {'dest': "db", 'default': "/opt/detectors/userdb.txt",
                                          'help': "signatures database"})])

